---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: tenantclusters.butler.butlerlabs.dev
spec:
  group: butler.butlerlabs.dev
  names:
    kind: TenantCluster
    listKind: TenantClusterList
    plural: tenantclusters
    shortNames:
    - tc
    singular: tenantcluster
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - description: Cluster phase
      jsonPath: .status.phase
      name: Phase
      type: string
    - description: Kubernetes version
      jsonPath: .spec.kubernetesVersion
      name: K8s Version
      type: string
    - description: Ready workers
      jsonPath: .status.observedState.workers.ready
      name: Workers
      type: string
    - description: API endpoint
      jsonPath: .status.controlPlaneEndpoint
      name: Endpoint
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          TenantCluster is the Schema for the tenantclusters API.
          It represents a complete Kubernetes cluster managed by Butler.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: TenantClusterSpec defines the desired state of TenantCluster.
            properties:
              addons:
                description: |-
                  Addons defines the initial addons to install.
                  These are installed at cluster creation time.
                  Additional addons can be added via TenantAddon resources.
                properties:
                  certManager:
                    description: CertManager configures cert-manager.
                    properties:
                      enabled:
                        default: true
                        description: Enabled indicates whether cert-manager should
                          be installed.
                        type: boolean
                      values:
                        description: Values are Helm values for customization.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      version:
                        description: Version is the addon version.
                        type: string
                    required:
                    - version
                    type: object
                  cni:
                    description: CNI configures the Container Network Interface.
                    properties:
                      provider:
                        default: cilium
                        description: Provider is the CNI provider.
                        enum:
                        - cilium
                        type: string
                      values:
                        description: Values are Helm values for customization.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      version:
                        description: Version is the addon version.
                        type: string
                    required:
                    - version
                    type: object
                  gitops:
                    description: GitOps configures GitOps (Flux or ArgoCD).
                    properties:
                      provider:
                        description: Provider is the GitOps provider.
                        enum:
                        - fluxcd
                        - argocd
                        type: string
                      repository:
                        description: Repository configures the Git repository for
                          GitOps.
                        properties:
                          branch:
                            default: main
                            description: Branch is the branch to use.
                            type: string
                          path:
                            description: Path is the path within the repository for
                              this cluster's manifests.
                            type: string
                          secretRef:
                            description: SecretRef references the Secret containing
                              Git credentials.
                            properties:
                              name:
                                description: Name is the name of the resource.
                                minLength: 1
                                type: string
                            required:
                            - name
                            type: object
                          url:
                            description: URL is the Git repository URL.
                            type: string
                        required:
                        - url
                        type: object
                      version:
                        description: Version is the addon version.
                        type: string
                    type: object
                  ingress:
                    description: Ingress configures the ingress controller.
                    properties:
                      provider:
                        description: Provider is the ingress provider.
                        enum:
                        - traefik
                        - nginx
                        type: string
                      values:
                        description: Values are Helm values for customization.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      version:
                        description: Version is the addon version.
                        type: string
                    required:
                    - version
                    type: object
                  loadBalancer:
                    description: LoadBalancer configures the load balancer.
                    properties:
                      provider:
                        default: metallb
                        description: Provider is the load balancer provider.
                        enum:
                        - metallb
                        type: string
                      values:
                        description: Values are Helm values for customization.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      version:
                        description: Version is the addon version.
                        type: string
                    required:
                    - version
                    type: object
                  storage:
                    description: Storage configures persistent storage.
                    properties:
                      provider:
                        description: Provider is the storage provider.
                        enum:
                        - longhorn
                        - linstor
                        type: string
                      values:
                        description: Values are Helm values for customization.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      version:
                        description: Version is the addon version.
                        type: string
                    required:
                    - version
                    type: object
                type: object
              controlPlane:
                description: ControlPlane configures the Kamaji-hosted control plane.
                properties:
                  certSANs:
                    description: |-
                      CertSANs are additional Subject Alternative Names for the API server certificate.
                      Use this to add custom DNS names or IPs for API server access.
                    items:
                      type: string
                    type: array
                  dataStoreRef:
                    description: |-
                      DataStoreRef references the Kamaji DataStore to use.
                      If not specified, the default DataStore is used.
                    properties:
                      name:
                        description: Name is the name of the resource.
                        minLength: 1
                        type: string
                    required:
                    - name
                    type: object
                  externalCloudProvider:
                    default: true
                    description: |-
                      ExternalCloudProvider enables --cloud-provider=external on apiserver and controller-manager.
                      Required for Harvester, vSphere, and other infrastructure providers.
                    type: boolean
                  replicas:
                    default: 1
                    description: |-
                      Replicas is the number of API server replicas.
                      Kamaji manages high availability automatically.
                    format: int32
                    maximum: 3
                    minimum: 1
                    type: integer
                  serviceType:
                    default: LoadBalancer
                    description: ServiceType for the control plane endpoint.
                    enum:
                    - LoadBalancer
                    - NodePort
                    - ClusterIP
                    type: string
                type: object
              kubernetesVersion:
                description: KubernetesVersion is the target Kubernetes version.
                pattern: ^v\d+\.\d+\.\d+$
                type: string
              managementPolicy:
                description: ManagementPolicy defines how Butler manages this cluster.
                properties:
                  mode:
                    default: Active
                    description: Mode determines how Butler manages addons.
                    enum:
                    - Active
                    - Observe
                    - GitOps
                    type: string
                type: object
              networking:
                description: Networking configures cluster networking.
                properties:
                  loadBalancerPool:
                    description: LoadBalancerPool defines the IP pool for LoadBalancer
                      services.
                    properties:
                      end:
                        description: End is the last IP in the pool.
                        type: string
                      start:
                        description: Start is the first IP in the pool.
                        type: string
                    required:
                    - end
                    - start
                    type: object
                  podCIDR:
                    default: 10.244.0.0/16
                    description: PodCIDR is the CIDR for pod IPs.
                    type: string
                  serviceCIDR:
                    default: 10.96.0.0/12
                    description: ServiceCIDR is the CIDR for service IPs.
                    type: string
                type: object
              providerConfigRef:
                description: |-
                  ProviderConfigRef references the ProviderConfig for infrastructure.
                  If not specified, defaults are used (Team's or platform's).
                properties:
                  name:
                    description: Name is the name of the resource.
                    minLength: 1
                    type: string
                required:
                - name
                type: object
              teamRef:
                description: |-
                  TeamRef references the Team this cluster belongs to.
                  Required when multi-tenancy mode is Enforced.
                properties:
                  name:
                    description: Name is the name of the resource.
                    minLength: 1
                    type: string
                required:
                - name
                type: object
              workers:
                description: Workers configures the worker nodes.
                properties:
                  machineTemplate:
                    description: MachineTemplate defines the VM specification for
                      workers.
                    properties:
                      cpu:
                        default: 4
                        description: CPU is the number of CPU cores.
                        format: int32
                        minimum: 1
                        type: integer
                      diskSize:
                        anyOf:
                        - type: integer
                        - type: string
                        default: 100Gi
                        description: DiskSize is the root disk size.
                        pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                        x-kubernetes-int-or-string: true
                      memory:
                        anyOf:
                        - type: integer
                        - type: string
                        default: 16Gi
                        description: Memory is the amount of RAM.
                        pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                        x-kubernetes-int-or-string: true
                      os:
                        description: OS configures the operating system.
                        properties:
                          imageRef:
                            description: |-
                              ImageRef references a specific image to use.
                              Overrides Type and Version if specified.
                            type: string
                          type:
                            default: rocky
                            description: Type is the OS type.
                            enum:
                            - rocky
                            - flatcar
                            type: string
                          version:
                            default: "9.5"
                            description: Version is the OS version.
                            type: string
                        type: object
                    type: object
                  replicas:
                    description: Replicas is the desired number of worker nodes.
                    format: int32
                    minimum: 1
                    type: integer
                required:
                - replicas
                type: object
            required:
            - kubernetesVersion
            - workers
            type: object
          status:
            description: TenantClusterStatus defines the observed state of TenantCluster.
            properties:
              conditions:
                description: Conditions represent the latest available observations.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              controlPlaneEndpoint:
                description: ControlPlaneEndpoint is the API server endpoint.
                type: string
              kubeconfigSecretRef:
                description: KubeconfigSecretRef references the Secret containing
                  the kubeconfig.
                properties:
                  name:
                    description: Name is the name of the resource.
                    minLength: 1
                    type: string
                required:
                - name
                type: object
              lastTransitionTime:
                description: LastTransitionTime is when the phase last changed.
                format: date-time
                type: string
              observedGeneration:
                description: ObservedGeneration is the last observed generation.
                format: int64
                type: integer
              observedState:
                description: ObservedState is the observed state of the cluster.
                properties:
                  addons:
                    description: Addons shows installed addon status.
                    items:
                      description: AddonStatus shows the status of an installed addon.
                      properties:
                        managedBy:
                          description: ManagedBy indicates who manages this addon.
                          enum:
                          - butler
                          - flux
                          - argocd
                          - manual
                          type: string
                        name:
                          description: Name is the addon name.
                          type: string
                        status:
                          description: Status is the addon health status.
                          enum:
                          - Pending
                          - Installing
                          - Healthy
                          - Degraded
                          - Failed
                          type: string
                        version:
                          description: Version is the installed version.
                          type: string
                      required:
                      - managedBy
                      - name
                      - status
                      - version
                      type: object
                    type: array
                  kubernetesVersion:
                    description: KubernetesVersion is the actual Kubernetes version
                      running.
                    type: string
                  workers:
                    description: Workers shows worker node status.
                    properties:
                      desired:
                        description: Desired is the desired number of workers.
                        format: int32
                        type: integer
                      nodes:
                        description: Nodes lists the worker nodes.
                        items:
                          type: string
                        type: array
                      ready:
                        description: Ready is the number of ready workers.
                        format: int32
                        type: integer
                    required:
                    - desired
                    - ready
                    type: object
                type: object
              phase:
                description: Phase represents the current phase of the cluster.
                enum:
                - Pending
                - Provisioning
                - Installing
                - Ready
                - Updating
                - Deleting
                - Failed
                type: string
              tenantNamespace:
                description: TenantNamespace is the namespace containing CAPI/Kamaji
                  resources.
                type: string
              workerNodesDesired:
                description: WorkerNodesDesired is the desired count of worker nodes
                format: int32
                type: integer
              workerNodesReady:
                description: WorkerNodesReady is the count of ready worker nodes
                format: int32
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
